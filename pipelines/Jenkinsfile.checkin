pipeline {
    agent any
    
    // Check-inè§¦å‘å™¨ - ä»£ç æäº¤æ—¶è‡ªåŠ¨è§¦å‘
    triggers {
        pollSCM('H/2 * * * *')  // æ¯2åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ä»£ç å˜åŒ–
    }
    
    // Check-inå‚æ•° - ä¿æŒç®€å•
    parameters {
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•'
        )
        booleanParam(
            name: 'FAST_BUILD',
            defaultValue: true,
            description: 'å¿«é€Ÿæ„å»ºæ¨¡å¼'
        )
    }
    
    // ç¯å¢ƒå˜é‡
    environment {
        APP_NAME = 'jenkins-checkin-app'
        BUILD_TYPE = 'check-in'
        BUILD_TIME = "${new Date().format('yyyy-MM-dd HH:mm:ss')}"
    }
    
    stages {
        stage('ğŸ“‹ Check-in åˆå§‹åŒ–') {
            steps {
                script {
                    echo "ğŸš€ å¼€å§‹ Check-in Pipeline"
                    echo "é¡¹ç›®: ${env.APP_NAME}"
                    echo "æ„å»ºç±»å‹: ${env.BUILD_TYPE}"
                    echo "æ„å»ºæ—¶é—´: ${env.BUILD_TIME}"
                    echo "å¿«é€Ÿæ¨¡å¼: ${params.FAST_BUILD}"
                    
                    // è®¾ç½®æ„å»ºæè¿°
                    currentBuild.description = "Check-in Build - ${env.GIT_BRANCH}"
                }
            }
        }
        
        stage('ğŸ“¥ ä»£ç æ£€å‡º') {
            steps {
                checkout scm
                script {
                    // è·å–Gitä¿¡æ¯
                    try {
                        env.GIT_COMMIT_SHORT = env.GIT_COMMIT?.take(8) ?: 'unknown'
                        env.GIT_BRANCH_NAME = env.GIT_BRANCH ?: 'unknown'
                        env.GIT_AUTHOR = env.CHANGE_AUTHOR ?: 'unknown'
                        
                        echo "åˆ†æ”¯: ${env.GIT_BRANCH_NAME}"
                        echo "æäº¤: ${env.GIT_COMMIT_SHORT}"
                        echo "ä½œè€…: ${env.GIT_AUTHOR}"
                    } catch (Exception e) {
                        echo "è·å–Gitä¿¡æ¯å¤±è´¥: ${e.getMessage()}"
                        env.GIT_COMMIT_SHORT = 'unknown'
                        env.GIT_BRANCH_NAME = 'unknown'
                        env.GIT_AUTHOR = 'unknown'
                    }
                }
            }
        }
        
        stage('ğŸ” ä»£ç æ£€æŸ¥') {
            parallel {
                stage('è¯­æ³•æ£€æŸ¥') {
                    steps {
                        script {
                            echo "æ‰§è¡Œä»£ç è¯­æ³•æ£€æŸ¥..."
                            // æ¨¡æ‹Ÿè¯­æ³•æ£€æŸ¥
                            sleep(1)
                            echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡"
                        }
                    }
                }
                stage('ä»£ç é£æ ¼') {
                    steps {
                        script {
                            echo "æ£€æŸ¥ä»£ç é£æ ¼..."
                            // æ¨¡æ‹Ÿä»£ç é£æ ¼æ£€æŸ¥
                            sleep(1)
                            echo "âœ… ä»£ç é£æ ¼æ£€æŸ¥é€šè¿‡"
                        }
                    }
                }
                stage('å®‰å…¨æ‰«æ') {
                    steps {
                        script {
                            echo "æ‰§è¡Œå®‰å…¨æ‰«æ..."
                            // æ¨¡æ‹Ÿå®‰å…¨æ‰«æ
                            sleep(1)
                            echo "âœ… å®‰å…¨æ‰«æé€šè¿‡"
                        }
                    }
                }
            }
        }
        
        stage('ğŸ”¨ å¿«é€Ÿæ„å»º') {
            steps {
                script {
                    if (params.FAST_BUILD) {
                        echo "æ‰§è¡Œå¿«é€Ÿæ„å»º..."
                        sleep(2)
                    } else {
                        echo "æ‰§è¡Œå®Œæ•´æ„å»º..."
                        sleep(5)
                    }
                    echo "âœ… æ„å»ºå®Œæˆ"
                }
            }
        }
        
        stage('ğŸ§ª å¿«é€Ÿæµ‹è¯•') {
            when {
                expression { !params.SKIP_TESTS }
            }
            parallel {
                stage('å•å…ƒæµ‹è¯•') {
                    steps {
                        script {
                            echo "è¿è¡Œæ ¸å¿ƒå•å…ƒæµ‹è¯•..."
                            // åªè¿è¡Œå…³é”®çš„å•å…ƒæµ‹è¯•
                            sleep(3)
                            echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
                        }
                    }
                }
                stage('é›†æˆæµ‹è¯•') {
                    when {
                        expression { !params.FAST_BUILD }
                    }
                    steps {
                        script {
                            echo "è¿è¡Œå…³é”®é›†æˆæµ‹è¯•..."
                            sleep(2)
                            echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡"
                        }
                    }
                }
            }
        }
        
        stage('ğŸ“Š è´¨é‡æ£€æŸ¥') {
            steps {
                script {
                    echo "æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
                    
                    // æ¨¡æ‹Ÿè´¨é‡æ£€æŸ¥ç»“æœ
                    def qualityReport = [
                        'coverage': 78,
                        'duplicated_lines': 5,
                        'bugs': 0,
                        'vulnerabilities': 0,
                        'code_smells': 2
                    ]
                    
                    echo "ä»£ç è¦†ç›–ç‡: ${qualityReport.coverage}%"
                    echo "é‡å¤ä»£ç : ${qualityReport.duplicated_lines}%"
                    echo "Bugæ•°é‡: ${qualityReport.bugs}"
                    echo "å®‰å…¨æ¼æ´: ${qualityReport.vulnerabilities}"
                    echo "ä»£ç å¼‚å‘³: ${qualityReport.code_smells}"
                    
                    // è´¨é‡é—¨æ£€æŸ¥
                    if (qualityReport.bugs > 0) {
                        error("âŒ å‘ç° ${qualityReport.bugs} ä¸ªBugï¼Œè¯·ä¿®å¤åå†æäº¤")
                    }
                    if (qualityReport.vulnerabilities > 0) {
                        error("âŒ å‘ç° ${qualityReport.vulnerabilities} ä¸ªå®‰å…¨æ¼æ´ï¼Œè¯·ä¿®å¤åå†æäº¤")
                    }
                    if (qualityReport.coverage < 70) {
                        currentBuild.result = 'UNSTABLE'
                        echo "âš ï¸ ä»£ç è¦†ç›–ç‡ä½äº70%ï¼Œå»ºè®®å¢åŠ æµ‹è¯•"
                    }
                    
                    echo "âœ… è´¨é‡æ£€æŸ¥é€šè¿‡"
                }
            }
        }
        
        stage('ğŸ“ Check-in æŠ¥å‘Š') {
            steps {
                script {
                    def duration = currentBuild.duration ?: 0
                    def status = currentBuild.result ?: 'SUCCESS'
                    
                    def report = """
                    ğŸ“‹ Check-in Pipeline æŠ¥å‘Š
                    ========================
                    é¡¹ç›®: ${env.APP_NAME}
                    åˆ†æ”¯: ${env.GIT_BRANCH_NAME}
                    æäº¤: ${env.GIT_COMMIT_SHORT}
                    ä½œè€…: ${env.GIT_AUTHOR}
                    çŠ¶æ€: ${status}
                    è€—æ—¶: ${duration}ms
                    æ¨¡å¼: ${params.FAST_BUILD ? 'å¿«é€Ÿæ¨¡å¼' : 'å®Œæ•´æ¨¡å¼'}
                    æµ‹è¯•: ${params.SKIP_TESTS ? 'å·²è·³è¿‡' : 'å·²æ‰§è¡Œ'}
                    æ—¶é—´: ${env.BUILD_TIME}
                    """
                    
                    echo report
                    
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€šçŸ¥é€»è¾‘
                    if (status == 'SUCCESS') {
                        echo "âœ… Check-in éªŒè¯æˆåŠŸï¼Œä»£ç å¯ä»¥å®‰å…¨æäº¤"
                    } else {
                        echo "âš ï¸ Check-in éªŒè¯å­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥å¹¶ä¿®å¤"
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "ğŸ Check-in Pipeline å®Œæˆ"
                
                // è®°å½•æ„å»ºä¿¡æ¯
                def buildInfo = [
                    'branch': env.GIT_BRANCH_NAME,
                    'commit': env.GIT_COMMIT_SHORT,
                    'author': env.GIT_AUTHOR,
                    'result': currentBuild.result ?: 'SUCCESS',
                    'duration': currentBuild.duration ?: 0
                ]
                
                echo "æ„å»ºä¿¡æ¯: ${buildInfo}"
            }
        }
        
        success {
            script {
                echo "âœ… Check-in æˆåŠŸ!"
                echo "ä»£ç è´¨é‡éªŒè¯é€šè¿‡ï¼Œå¯ä»¥ç»§ç»­å¼€å‘æˆ–åˆå¹¶"
                
                // å¯ä»¥æ·»åŠ æˆåŠŸé€šçŸ¥
                // ä¾‹å¦‚ï¼šå‘é€Slackæ¶ˆæ¯ã€æ›´æ–°GitçŠ¶æ€ç­‰
            }
        }
        
        failure {
            script {
                echo "âŒ Check-in å¤±è´¥!"
                echo "è¯·ä¿®å¤é—®é¢˜åé‡æ–°æäº¤ä»£ç "
                
                // å¯ä»¥æ·»åŠ å¤±è´¥é€šçŸ¥
                // ä¾‹å¦‚ï¼šå‘é€é‚®ä»¶ç»™æäº¤è€…ã€åˆ›å»ºJira ticketç­‰
            }
        }
        
        unstable {
            script {
                echo "âš ï¸ Check-in ä¸ç¨³å®š"
                echo "ä»£ç å¯ä»¥æäº¤ï¼Œä½†å»ºè®®æ”¹è¿›è´¨é‡"
            }
        }
        
        aborted {
            script {
                echo "ğŸ›‘ Check-in è¢«ä¸­æ­¢"
                echo "Pipeline æ‰§è¡Œè¢«ç”¨æˆ·æˆ–ç³»ç»Ÿä¸­æ­¢"
            }
        }
    }
}
