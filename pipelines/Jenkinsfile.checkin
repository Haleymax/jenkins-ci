pipeline {
    agent any
    
    // Check-inè§¦å‘å™¨ - ä»£ç æäº¤æ—¶è‡ªåŠ¨è§¦å‘
    triggers {
        pollSCM('H/2 * * * *')  // æ¯2åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ä»£ç å˜åŒ–
    }
    
    // Check-inå‚æ•°
    parameters {
        string(
            name: 'TEST_SCRIPT_NAME',
            defaultValue: 'check_in_test.py',
            description: 'è¦æ‰§è¡Œçš„æµ‹è¯•è„šæœ¬åç§° (å¦‚: xxxx.py)'
        )
        choice(
            name: 'TEST_ENV',
            choices: ['dev', 'test', 'staging'],
            description: 'æµ‹è¯•ç¯å¢ƒ'
        )
        booleanParam(
            name: 'GENERATE_ALLURE',
            defaultValue: true,
            description: 'æ˜¯å¦ç”ŸæˆAllureæŠ¥å‘Š'
        )
        booleanParam(
            name: 'CLEAN_WORKSPACE',
            defaultValue: false,
            description: 'è¿è¡Œå‰æ¸…ç†å·¥ä½œç©ºé—´'
        )
        string(
            name: 'PYTHON_VERSION',
            defaultValue: 'python3',
            description: 'Pythonç‰ˆæœ¬ (python/python3)'
        )
    }
    
    // ç¯å¢ƒå˜é‡
    environment {
        APP_NAME = 'jenkins-checkin-test'
        BUILD_TYPE = 'check-in-test'
        BUILD_TIME = "${new Date().format('yyyy-MM-dd HH:mm:ss')}"
        ALLURE_RESULTS_DIR = 'allure-results'
        ALLURE_REPORT_DIR = 'allure-report'
        TEST_REPORTS_DIR = 'test-reports'
        // Ubuntuç¯å¢ƒä¼˜åŒ–
        DEBIAN_FRONTEND = 'noninteractive'
        LANG = 'C.UTF-8'
        LC_ALL = 'C.UTF-8'
    }
    
    stages {
        stage('ï¿½ Check-in æµ‹è¯•åˆå§‹åŒ–') {
            steps {
                script {
                    echo "ğŸš€ å¼€å§‹ Check-in æµ‹è¯•æµç¨‹"
                    echo "é¡¹ç›®: ${env.APP_NAME}"
                    echo "æ„å»ºç±»å‹: ${env.BUILD_TYPE}"
                    echo "æ„å»ºæ—¶é—´: ${env.BUILD_TIME}"
                    echo "æµ‹è¯•è„šæœ¬: ${params.TEST_SCRIPT_NAME}"
                    echo "æµ‹è¯•ç¯å¢ƒ: ${params.TEST_ENV}"
                    echo "Pythonç‰ˆæœ¬: ${params.PYTHON_VERSION}"
                    
                    // è®¾ç½®æ„å»ºæè¿°
                    currentBuild.description = "Check-in Test - ${params.TEST_SCRIPT_NAME} (${params.TEST_ENV})"
                    
                    // æ¸…ç†å·¥ä½œç©ºé—´
                    if (params.CLEAN_WORKSPACE) {
                        echo "ğŸ§¹ æ¸…ç†å·¥ä½œç©ºé—´..."
                        cleanWs()
                    }
                }
            }
        }
        
        stage('ğŸ“¥ æ‹‰å–æµ‹è¯•ä»£ç ') {
            steps {
                script {
                    echo "ğŸ“¥ ä»æŒ‡å®šä»“åº“æ‹‰å–æµ‹è¯•ä»£ç ..."
                    echo "ğŸ  å½“å‰å·¥ä½œç©ºé—´ï¼š${env.WORKSPACE}"
                }
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'http://110.41.2.77:9999/haley/Android-automation-script.git',
                        credentialsId: 'gitea-api'
                    ]]
                ])
                script {
                    echo "ğŸ“‚ ä»£ç æ‹‰å–å®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨ï¼š"
                    sh "ls -la"
                    echo "ğŸ“ æµ‹è¯•ä»£ç ä½ç½®ï¼š${env.WORKSPACE}"
                    // è·å–Gitä¿¡æ¯
                    try {
                        env.GIT_COMMIT_SHORT = env.GIT_COMMIT?.take(8) ?: 'unknown'
                        env.GIT_BRANCH_NAME = env.GIT_BRANCH ?: 'unknown'
                        env.GIT_AUTHOR = env.CHANGE_AUTHOR ?: 'unknown'
                        
                        echo "åˆ†æ”¯: ${env.GIT_BRANCH_NAME}"
                        echo "æäº¤: ${env.GIT_COMMIT_SHORT}"
                        echo "ä½œè€…: ${env.GIT_AUTHOR}"
                        
                        // éªŒè¯æµ‹è¯•è„šæœ¬æ˜¯å¦å­˜åœ¨ (Ubuntuä¼˜åŒ–)
                        def scriptExists = sh(script: "test -f ${params.TEST_SCRIPT_NAME} && echo 'exists' || echo 'not_found'", returnStdout: true).trim()
                        if (scriptExists == 'not_found') {
                            echo "âš ï¸ è­¦å‘Š: æµ‹è¯•è„šæœ¬ ${params.TEST_SCRIPT_NAME} ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿæµ‹è¯•"
                            env.SCRIPT_EXISTS = 'false'
                        } else {
                            echo "âœ… æ‰¾åˆ°æµ‹è¯•è„šæœ¬: ${params.TEST_SCRIPT_NAME}"
                            
                            // æ£€æŸ¥è„šæœ¬æƒé™
                            def executable = sh(script: "test -x ${params.TEST_SCRIPT_NAME} && echo 'true' || echo 'false'", returnStdout: true).trim()
                            if (executable == 'false') {
                                echo "ğŸ”§ è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™..."
                                sh "chmod +x ${params.TEST_SCRIPT_NAME}"
                            }
                            
                            env.SCRIPT_EXISTS = 'true'
                        }
                    } catch (Exception e) {
                        echo "è·å–Gitä¿¡æ¯å¤±è´¥: ${e.getMessage()}"
                        env.GIT_COMMIT_SHORT = 'unknown'
                        env.GIT_BRANCH_NAME = 'unknown'
                        env.GIT_AUTHOR = 'unknown'
                        env.SCRIPT_EXISTS = 'false'
                    }
                    
                    // Pythonè™šæ‹Ÿç¯å¢ƒæ¿€æ´»å’Œä¾èµ–å®‰è£…
                    echo "ğŸ æ¿€æ´»Pythonè™šæ‹Ÿç¯å¢ƒ..."
                    try {
                        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è™šæ‹Ÿç¯å¢ƒç›®å½•
                        def venvExists = sh(script: "test -d venv && echo 'exists' || echo 'not_found'", returnStdout: true).trim()
                        if (venvExists == 'not_found') {
                            echo "ğŸ“¦ åˆ›å»ºPythonè™šæ‹Ÿç¯å¢ƒ..."
                            sh "${params.PYTHON_VERSION} -m venv venv"
                        } else {
                            echo "âœ… è™šæ‹Ÿç¯å¢ƒå·²å­˜åœ¨"
                        }
                        
                        // æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶æ£€æŸ¥Pythonç‰ˆæœ¬
                        echo "ğŸ”— æ¿€æ´»è™šæ‹Ÿç¯å¢ƒå¹¶æ£€æŸ¥Pythonç‰ˆæœ¬..."
                        sh """
                            source venv/bin/activate
                            python --version
                            pip --version
                        """
                        
                        echo "â­ï¸ è·³è¿‡ä¾èµ–å®‰è£…æ­¥éª¤"
                        echo "ğŸ“‹ å¦‚éœ€å®‰è£…ä¾èµ–ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œæˆ–ä¿®æ”¹pipelineé…ç½®"
                        
                        // éªŒè¯è™šæ‹Ÿç¯å¢ƒçŠ¶æ€
                        echo "ï¿½ è™šæ‹Ÿç¯å¢ƒåŸºæœ¬ä¿¡æ¯ï¼š"
                        sh """
                            source venv/bin/activate
                            echo "Pythonè·¯å¾„: \$(which python)"
                            echo "Pipè·¯å¾„: \$(which pip)"
                            echo "è™šæ‹Ÿç¯å¢ƒç›®å½•: \$(pwd)/venv"
                        """
                        
                        env.VENV_ACTIVATED = 'true'
                        echo "âœ… Pythonè™šæ‹Ÿç¯å¢ƒå‡†å¤‡å®Œæˆ"
                        
                    } catch (Exception e) {
                        echo "âŒ Pythonè™šæ‹Ÿç¯å¢ƒæ¿€æ´»å¤±è´¥: ${e.getMessage()}"
                        env.VENV_ACTIVATED = 'false'
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
        
        stage('ğŸ”§ ç¯å¢ƒå‡†å¤‡') {
            steps {
                script {
                    echo "ğŸ”§ å‡†å¤‡Ubuntuæµ‹è¯•ç¯å¢ƒ..."
                    
                    // æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
                    echo "ï¿½ï¸ ç³»ç»Ÿä¿¡æ¯ï¼š"
                    sh "uname -a"
                    
                    // æ£€æŸ¥è™šæ‹Ÿç¯å¢ƒçŠ¶æ€
                    if (env.VENV_ACTIVATED == 'true') {
                        echo "âœ… Pythonè™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»"
                        sh """
                            source venv/bin/activate
                            echo "Pythonè·¯å¾„: \$(which python)"
                            echo "Pipè·¯å¾„: \$(which pip)"
                            python --version
                        """
                    } else {
                        echo "âš ï¸ Pythonè™šæ‹Ÿç¯å¢ƒæœªæ¿€æ´»ï¼Œä½¿ç”¨ç³»ç»ŸPython"
                        sh """
                            echo "ç³»ç»ŸPythonè·¯å¾„: \$(which ${params.PYTHON_VERSION})"
                            ${params.PYTHON_VERSION} --version
                        """
                    }
                    
                    // æ£€æŸ¥Androidç›¸å…³ç¯å¢ƒï¼ˆå¦‚æœéœ€è¦ï¼‰
                    echo "ğŸ“± æ£€æŸ¥Androidç¯å¢ƒ..."
                    try {
                        sh "adb version || echo 'ADBæœªå®‰è£…'"
                    } catch (Exception e) {
                        echo "âš ï¸ ADBæ£€æŸ¥å¤±è´¥: ${e.getMessage()}"
                    }
                    
                    echo "âœ… Ubuntuç¯å¢ƒå‡†å¤‡å®Œæˆ"
                }
            }
        }
        
        stage('ğŸ§ª æ‰§è¡ŒCheck-inæµ‹è¯•') {
            steps {
                script {
                    echo "ğŸ§ª å¼€å§‹Check-inæµ‹è¯•å‡†å¤‡å·¥ä½œ..."
                    
                    try {
                        // æ£€æŸ¥test_caseç›®å½•æ˜¯å¦å­˜åœ¨
                        def testCaseDirExists = sh(script: "test -d test_case && echo 'exists' || echo 'not_found'", returnStdout: true).trim()
                        
                        if (testCaseDirExists == 'exists') {
                            echo "ï¿½ æ‰¾åˆ°test_caseç›®å½•ï¼Œåˆ—å‡ºæ‰€æœ‰æµ‹è¯•è„šæœ¬ï¼š"
                            sh """
                                echo "ğŸ“‚ test_caseç›®å½•å†…å®¹ï¼š"
                                ls -la test_case/
                                echo ""
                                echo "ğŸ Pythonæµ‹è¯•è„šæœ¬(.pyæ–‡ä»¶)ï¼š"
                                find test_case -name "*.py" -type f | sort
                                echo ""
                                echo "ï¿½ è„šæœ¬ç»Ÿè®¡ï¼š"
                                echo "æ€»æ–‡ä»¶æ•°: \$(find test_case -type f | wc -l)"
                                echo "Pythonè„šæœ¬æ•°: \$(find test_case -name "*.py" -type f | wc -l)"
                                echo "å…¶ä»–æ–‡ä»¶æ•°: \$(find test_case -type f ! -name "*.py" | wc -l)"
                            """
                        } else {
                            echo "âš ï¸ æœªæ‰¾åˆ°test_caseç›®å½•ï¼Œæ£€æŸ¥æ ¹ç›®å½•ä¸‹çš„Pythonæ–‡ä»¶ï¼š"
                            sh """
                                echo "ğŸ“‚ æ ¹ç›®å½•Pythonæ–‡ä»¶ï¼š"
                                find . -maxdepth 1 -name "*.py" -type f | sort
                                echo ""
                                echo "ï¿½ æ‰€æœ‰ç›®å½•ï¼š"
                                find . -maxdepth 1 -type d | sort
                            """
                        }
                        
                        // æ£€æŸ¥æŒ‡å®šçš„æµ‹è¯•è„šæœ¬
                        if (env.SCRIPT_EXISTS == 'true') {
                            echo "âœ… æŒ‡å®šçš„æµ‹è¯•è„šæœ¬å­˜åœ¨: ${params.TEST_SCRIPT_NAME}"
                            sh """
                                echo "ğŸ“„ è„šæœ¬è¯¦ç»†ä¿¡æ¯ï¼š"
                                ls -la ${params.TEST_SCRIPT_NAME}
                                echo "ğŸ“ è„šæœ¬å‰10è¡Œå†…å®¹ï¼š"
                                head -n 10 ${params.TEST_SCRIPT_NAME}
                            """
                        } else {
                            echo "âš ï¸ æŒ‡å®šçš„æµ‹è¯•è„šæœ¬ä¸å­˜åœ¨: ${params.TEST_SCRIPT_NAME}"
                        }
                        
                        echo "âœ… æµ‹è¯•è„šæœ¬æ£€æŸ¥å®Œæˆ"
                        echo "ğŸ”„ æš‚æ—¶è·³è¿‡è„šæœ¬æ‰§è¡Œï¼Œä»…è¿›è¡Œç¯å¢ƒæ£€æŸ¥"
                        
                    } catch (Exception e) {
                        echo "âŒ æµ‹è¯•è„šæœ¬æ£€æŸ¥å¤±è´¥: ${e.getMessage()}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
        }
        
        stage('ğŸ“Š å‘å¸ƒAllureæŠ¥å‘Š') {
            when {
                expression { params.GENERATE_ALLURE }
            }
            steps {
                script {
                    echo "ğŸ“Š å‘å¸ƒAllureæµ‹è¯•æŠ¥å‘Šåˆ°Jenkins..."
                    echo "ğŸ” è¿™é‡Œä¼šæ£€æŸ¥æµ‹è¯•ç»“æœæ–‡ä»¶ï¼Œåˆ›å»ºAllureæŠ¥å‘Šï¼Œå¹¶ä½¿ç”¨Jenkins Allureæ’ä»¶å‘å¸ƒ"
                    
                    try {
                        // ä½¿ç”¨Jenkins Allureæ’ä»¶å‘å¸ƒæŠ¥å‘Š
                        allure([
                            includeProperties: false,
                            jdk: '',
                            properties: [],
                            reportBuildPolicy: 'ALWAYS',
                            results: [[path: env.ALLURE_RESULTS_DIR]]
                        ])
                        
                        echo "âœ… AllureæŠ¥å‘Šå·²å‘å¸ƒåˆ°Jenkins"
                        
                    } catch (Exception e) {
                        echo "âš ï¸ AllureæŠ¥å‘Šå‘å¸ƒå¤±è´¥: ${e.getMessage()}"
                        currentBuild.result = 'UNSTABLE'
                    }
                }
            }
            post {
                always {
                    // å½’æ¡£æµ‹è¯•ç»“æœæ–‡ä»¶
                    archiveArtifacts artifacts: "${env.ALLURE_RESULTS_DIR}/**/*", allowEmptyArchive: true, fingerprint: true
                    archiveArtifacts artifacts: "${env.TEST_REPORTS_DIR}/**/*", allowEmptyArchive: true, fingerprint: true
                }
            }
        }
        
        stage('ğŸ“ Check-in æµ‹è¯•æŠ¥å‘Š') {
            steps {
                script {
                    def duration = currentBuild.duration ?: 0
                    def status = currentBuild.result ?: 'SUCCESS'
                    
                    def report = """
                    ğŸ“‹ Check-in æµ‹è¯•æŠ¥å‘Š
                    ========================
                    é¡¹ç›®: ${env.APP_NAME}
                    æµ‹è¯•è„šæœ¬: ${params.TEST_SCRIPT_NAME}
                    æµ‹è¯•ç¯å¢ƒ: ${params.TEST_ENV}
                    åˆ†æ”¯: ${env.GIT_BRANCH_NAME}
                    æäº¤: ${env.GIT_COMMIT_SHORT}
                    ä½œè€…: ${env.GIT_AUTHOR}
                    çŠ¶æ€: ${status}
                    è€—æ—¶: ${duration}ms
                    Pythonç‰ˆæœ¬: ${params.PYTHON_VERSION}
                    AllureæŠ¥å‘Š: ${params.GENERATE_ALLURE ? 'å·²ç”Ÿæˆ' : 'å·²è·³è¿‡'}
                    æ„å»ºæ—¶é—´: ${env.BUILD_TIME}
                    æ„å»ºå·: ${env.BUILD_NUMBER}
                    """
                    
                    echo report
                    
                    // æµ‹è¯•ç»“æœåˆ†æ
                    if (status == 'SUCCESS') {
                        echo "âœ… Check-in æµ‹è¯•æˆåŠŸï¼"
                        echo "ğŸ“Š æ‰€æœ‰æµ‹è¯•æ­¥éª¤å·²å®Œæˆ"
                        if (params.GENERATE_ALLURE) {
                            echo "ğŸ“‹ AllureæŠ¥å‘Šå·²å‘å¸ƒï¼Œå¯åœ¨æ„å»ºé¡µé¢æŸ¥çœ‹"
                        }
                    } else if (status == 'UNSTABLE') {
                        echo "âš ï¸ Check-in æµ‹è¯•ä¸ç¨³å®š"
                        echo "æŸäº›æ­¥éª¤å¯èƒ½å¤±è´¥ï¼Œä½†æµ‹è¯•å·²å®Œæˆ"
                    } else {
                        echo "âŒ Check-in æµ‹è¯•å¤±è´¥"
                        echo "è¯·æ£€æŸ¥æµ‹è¯•è„šæœ¬å’Œç¯å¢ƒé…ç½®"
                    }
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "ğŸ Check-in æµ‹è¯•æµç¨‹å®Œæˆ"
                
                // è®°å½•æ„å»ºä¿¡æ¯
                def buildInfo = [
                    'script': params.TEST_SCRIPT_NAME,
                    'environment': params.TEST_ENV,
                    'branch': env.GIT_BRANCH_NAME,
                    'commit': env.GIT_COMMIT_SHORT,
                    'author': env.GIT_AUTHOR,
                    'result': currentBuild.result ?: 'SUCCESS',
                    'duration': currentBuild.duration ?: 0,
                    'python_version': params.PYTHON_VERSION,
                    'allure_generated': params.GENERATE_ALLURE
                ]
                
                echo "æ„å»ºä¿¡æ¯: ${buildInfo}"
                
                // æ¸…ç†ä¸´æ—¶æ–‡ä»¶ (å¯é€‰)
                if (params.CLEAN_WORKSPACE) {
                    echo "ğŸ§¹ è¿™é‡Œä¼šæ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œå·¥ä½œç©ºé—´"
                }
            }
        }
        
        success {
            script {
                echo "âœ… Check-in æµ‹è¯•æˆåŠŸï¼"
                echo "ğŸ‰ æµ‹è¯•è„šæœ¬ ${params.TEST_SCRIPT_NAME} æ‰§è¡Œå®Œæˆ"
                if (params.GENERATE_ALLURE) {
                    echo "ğŸ“Š AllureæŠ¥å‘Šå·²ç”Ÿæˆï¼Œå¯åœ¨Jenkinsæ„å»ºé¡µé¢æŸ¥çœ‹"
                }
                echo "ğŸš€ ä»£ç å¯ä»¥å®‰å…¨æäº¤æˆ–åˆå¹¶"
                
                // å¯ä»¥æ·»åŠ æˆåŠŸé€šçŸ¥
                // ä¾‹å¦‚ï¼šå‘é€Slackæ¶ˆæ¯ã€æ›´æ–°GitçŠ¶æ€ã€å‘é€é‚®ä»¶ç­‰
            }
        }
        
        failure {
            script {
                echo "âŒ Check-in æµ‹è¯•å¤±è´¥ï¼"
                echo "ğŸ’¥ æµ‹è¯•è„šæœ¬ ${params.TEST_SCRIPT_NAME} æ‰§è¡Œå¤±è´¥"
                echo "ğŸ” è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹:"
                echo "   - æµ‹è¯•è„šæœ¬æ˜¯å¦å­˜åœ¨: ${params.TEST_SCRIPT_NAME}"
                echo "   - Pythonç¯å¢ƒæ˜¯å¦æ­£ç¡®: ${params.PYTHON_VERSION}"
                echo "   - æµ‹è¯•ç¯å¢ƒæ˜¯å¦å¯ç”¨: ${params.TEST_ENV}"
                echo "   - ä¾èµ–åŒ…æ˜¯å¦å·²å®‰è£…"
                
                // å¯ä»¥æ·»åŠ å¤±è´¥é€šçŸ¥
                // ä¾‹å¦‚ï¼šå‘é€é‚®ä»¶ç»™å¼€å‘è€…ã€åˆ›å»ºJira ticketã€å‘é€é’‰é’‰æ¶ˆæ¯ç­‰
            }
        }
        
        unstable {
            script {
                echo "âš ï¸ Check-in æµ‹è¯•ä¸ç¨³å®š"
                echo "ğŸ“‹ éƒ¨åˆ†æµ‹è¯•å¯èƒ½å¤±è´¥ï¼Œä½†æµç¨‹å·²å®Œæˆ"
                echo "ğŸ”§ å»ºè®®æ£€æŸ¥æµ‹è¯•ç»“æœå’ŒAllureæŠ¥å‘Š"
            }
        }
        
        aborted {
            script {
                echo "ğŸ›‘ Check-in æµ‹è¯•è¢«ä¸­æ­¢"
                echo "â¹ï¸ Pipeline æ‰§è¡Œè¢«ç”¨æˆ·æˆ–ç³»ç»Ÿä¸­æ­¢"
                echo "ğŸ”„ å¯ä»¥é‡æ–°è§¦å‘æ„å»º"
            }
        }
    }
}
